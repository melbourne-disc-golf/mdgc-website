---
import { getCollection } from 'astro:content';

const courses = await getCollection('courses');

// Prepare courses for map - parse GeoJSON location data
const coursesWithLocation = courses.map(course => {
	let location = undefined;

	if (course.data.location) {
		try {
			const parsed = JSON.parse(course.data.location);
			if (parsed.type === 'Point' && parsed.coordinates) {
				// GeoJSON uses [longitude, latitude] order
				location = { lat: parsed.coordinates[1], lng: parsed.coordinates[0] };
			}
		} catch (e) {
			// Ignore parse errors
		}
	}

	return {
		name: course.data.title,
		slug: course.slug,
		suburb: course.data.suburb,
		location
	};
}).filter(c => c.location);
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<div id="course-map" class="w-full aspect-3/2 rounded-lg"></div>

<style>
	/* Custom popup styling */
	:global(.leaflet-popup-content-wrapper) {
		border-radius: 8px;
	}
	:global(.leaflet-popup-content) {
		margin: 12px 16px;
		font-family: inherit;
	}
	:global(.leaflet-popup-content h3) {
		margin: 0 0 8px 0;
		font-size: 16px;
		font-weight: 600;
		color: #1e3a8a;
	}
	:global(.leaflet-popup-content a) {
		color: #2563eb;
		text-decoration: none;
		font-weight: 500;
	}
	:global(.leaflet-popup-content a:hover) {
		text-decoration: underline;
	}
</style>

<script is:inline define:vars={{ coursesWithLocation }}>
	// Load Leaflet dynamically
	const script = document.createElement('script');
	script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
	script.onload = () => {
		// Initialize map with scroll wheel zoom disabled
		const map = L.map('course-map', {
			scrollWheelZoom: false
		});

		// Add CartoDB Voyager tiles - clean, light cartographic style
		L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
			attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
			maxZoom: 20,
			subdomains: 'abcd'
		}).addTo(map);

		// Add markers for each course
		coursesWithLocation.forEach(course => {
			const marker = L.marker([course.location.lat, course.location.lng]).addTo(map);

			const popupContent = `
				<div>
					<h3 style="margin: 0;"><a href="/courses/${course.slug}">${course.name}</a></h3>
					<p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">${course.suburb}</p>
				</div>
			`;

			marker.bindPopup(popupContent, {
				maxWidth: 280,
				closeButton: false,
				autoPan: false
			});

			// Track whether hover has been triggered (indicates desktop with mouse)
			let hasHovered = false;

			// Open popup on hover (desktop only)
			marker.on('mouseover', function() {
				hasHovered = true;
				this.openPopup();
			});

			// Click behavior: use hover state to determine device type
			let clickTimer = null;
			marker.on('click', function(e) {
				// If hover hasn't fired, this is likely a touch device
				if (!hasHovered) {
					// Mobile/touch: first click opens popup, second click or link click navigates
					if (this.isPopupOpen()) {
						// Only navigate if clicking the marker again (not the link)
						const clickedOnLink = e.originalEvent && e.originalEvent.target.tagName === 'A';
						if (!clickedOnLink) {
							window.location.href = `/courses/${course.slug}`;
						}
					} else {
						this.openPopup();
						// Auto-close after delay if user doesn't interact
						if (clickTimer) clearTimeout(clickTimer);
						clickTimer = setTimeout(() => {
							if (!this._hoveredPopup) {
								this.closePopup();
							}
						}, 3000);
					}
				} else {
					// Desktop: click navigates immediately (hover already shows popup)
					window.location.href = `/courses/${course.slug}`;
				}
			});

			// Close popup when mouse leaves both marker and popup
			marker.on('mouseout', function() {
				const popup = this.getPopup();
				const popupElement = popup.getElement();

				// Don't close if moving to the popup
				if (popupElement && popupElement.matches(':hover')) {
					return;
				}

				setTimeout(() => {
					if (popupElement && !popupElement.matches(':hover') && !this._icon.matches(':hover')) {
						this.closePopup();
					}
				}, 100);
			});

			// Keep popup open when hovering over it
			marker.on('popupopen', function() {
				const popup = this.getPopup();
				const popupElement = popup.getElement();

				if (popupElement) {
					popupElement.addEventListener('mouseover', () => {
						this._hoveredPopup = true;
					});

					popupElement.addEventListener('mouseout', () => {
						this._hoveredPopup = false;
						setTimeout(() => {
							if (!this._hoveredPopup && !this._icon.matches(':hover')) {
								this.closePopup();
							}
						}, 100);
					});
				}
			});
		});

		// Calculate bounds from all course locations
		const points = coursesWithLocation.map(c => [c.location.lat, c.location.lng]);
		const bounds = L.latLngBounds(points).pad(0.1); // 10% padding
		map.fitBounds(bounds);

		// Show the bounding rectangle (for debugging/adjustment)
		// L.rectangle(bounds, { color: '#ef4444', weight: 2, fill: false, dashArray: '5, 5' }).addTo(map);
	};
	document.head.appendChild(script);
</script>
