---
import { getCollection } from 'astro:content';
import EventCalendar from '@components/EventCalendar.astro';
import { clubEventToCalendarEvent, externalEventToCalendarEvent, socialDayToCalendarEvent } from '@utils/events';

// Get data from collections
const clubEvents = await getCollection('events');
const externalEvents = await getCollection('externalEvents');
const metrixSeasons = await getCollection('metrixSeasons');
const courses = await getCollection('courses');

// Build course lookup maps
const coursesBySlug = new Map(courses.map((c) => [c.slug, c]));
const metrixToCourse = new Map<string, string>();
for (const course of courses) {
  for (const id of course.data.metrixCourseIds || []) {
    metrixToCourse.set(id, course.data.title);
  }
}

const today = new Date();
today.setHours(0, 0, 0, 0);

// Convert club events to CalendarEvents
const clubCalendarEvents = clubEvents
  .map(e => clubEventToCalendarEvent(e, coursesBySlug));

// Convert external events to CalendarEvents
const externalCalendarEvents = externalEvents
  .map(e => externalEventToCalendarEvent(e));

// Convert metrix social days to CalendarEvents
const socialDays = metrixSeasons
  .flatMap(season => season.data.events)
  .map(e => socialDayToCalendarEvent(e, metrixToCourse));

// Combine all events
const allEvents = [...clubCalendarEvents, ...externalCalendarEvents, ...socialDays];
---

<EventCalendar events={allEvents} maxDaysInPast={3} maxDaysInFuture={90}/>
