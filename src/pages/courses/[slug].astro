---
import { getCollection, getEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '@layouts/Layout.astro';
import Text from '@components/Text.astro';
import LocationsMap from '@components/LocationsMap.astro';
import EventCalendarList from '@components/EventCalendarList.astro';
import { clubEventToCalendarEvent } from '@utils/events';

export async function getStaticPaths() {
  const courses = await getCollection('courses');
  return courses.map((course) => ({
    params: { slug: course.slug },
    props: { course },
  }));
}

const { course } = Astro.props;
const { Content } = await course.render();

// Get disc library if referenced
const discLibrary = course.data.discLibrary ? await getEntry(course.data.discLibrary) : null;

// Get upcoming events at this course (include events up to 2 days in past to match component display)
const maxDaysInPast = 2;
const cutoffDate = new Date();
cutoffDate.setDate(cutoffDate.getDate() - maxDaysInPast);
const allEvents = await getCollection('events');
const allCourses = await getCollection('courses');
const coursesBySlug = new Map(allCourses.map((c) => [c.slug, c]));
const upcomingEventsAtThisCourse = allEvents.filter((event) =>
  event.data.courses?.some((ref) => ref.id === course.slug) &&
  new Date(event.data.date) >= cutoffDate
);
const calendarEvents = upcomingEventsAtThisCourse.map((e) => clubEventToCalendarEvent(e, coursesBySlug));

// Parse location coordinates (mandatory)
if (!course.data.location) {
  throw new Error(`Course ${course.slug} is missing required location data`);
}
const parsed = JSON.parse(course.data.location);
const lat = parsed.coordinates[1];
const lng = parsed.coordinates[0];

// Generate map links
const mapLinks = {
  google: course.data.googleMapsUrl || `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`,
  apple: `https://maps.apple.com/?q=${encodeURIComponent(course.data.title + ' Disc Golf')}&ll=${lat},${lng}`
};
---

<Layout
  title={course.data.title}
  subtitle={course.data.suburb}
  cmsPath={`/collections/courses/entries/${course.slug}`}
  heroImage={course.data.mainImage && {
    src: course.data.mainImage,
    alt: course.data.title,
    class: "aspect-2/1"
  }}
>
  <Text>

    <Content />

    <section>
      <h2>Location</h2>
      <LocationsMap locations={[{ lat, lng, title: course.data.title }]} permanentTooltips />
      <p>
        View in:
        <a href={mapLinks.google} target="_blank" rel="noopener noreferrer">Google Maps</a>
        {' Â· '}
        <a href={mapLinks.apple} target="_blank" rel="noopener noreferrer">Apple Maps</a>
      </p>
    </section>

    {discLibrary && (
      <section>
        <h2>Nearest disc library</h2>
        <p>If you don't have your own discs, you can borrow some from <a href={discLibrary.data.url}>{discLibrary.data.location}</a>.</p>
      </section>
    )}

    {(course.data.courseMap || course.data.udiscUrl) && (
      <section>
        <h2>Course layout</h2>
        {course.data.udiscUrl && (
          <p>
            View on: <a href={course.data.udiscUrl} target="_blank" rel="noopener noreferrer">uDisc</a>
          </p>
        )}
        {course.data.courseMap && (
          <a href={course.data.courseMap.src}>
            <Image
              src={course.data.courseMap}
              alt={`${course.data.title} course layout`}
              class="w-full rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
              inferSize={true}
            />
          </a>
        )}
      </section>
    )}

    {calendarEvents.length > 0 && (
      <section>
        <h2>Upcoming events</h2>
        <EventCalendarList events={calendarEvents} maxDaysInPast={maxDaysInPast} />
      </section>
    )}

  </Text>

</Layout>
