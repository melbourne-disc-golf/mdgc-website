---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import CourseCard from '@components/CourseCard.astro';
import LocationsMap from '@components/LocationsMap.astro';
import Grid from '@components/Grid.astro';
import LinkPanel from '@components/LinkPanel.astro';
import Section from '@components/Section.astro';
import Text from '@components/Text.astro';

const allCourses = await getCollection('courses');
const featuredCourses = allCourses.filter(course => course.data.featured);
const otherCourses = allCourses.filter(course => !course.data.featured);
featuredCourses.sort((a, b) => a.data.title.localeCompare(b.data.title));
otherCourses.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Prepare locations for the map (all courses, not just featured)
const courseLocations = allCourses.flatMap(course => {
	if (!course.data.location) return [];
	try {
		const parsed = JSON.parse(course.data.location);
		if (parsed.type === 'Point' && parsed.coordinates) {
			return [{
				lat: parsed.coordinates[1] as number,
				lng: parsed.coordinates[0] as number,
				title: course.data.title,
				subtitle: course.data.suburb,
				href: `/courses/${course.slug}`,
				secondary: !course.data.featured
			}];
		}
	} catch (e) {
		// Ignore parse errors
	}
	return [];
});
---

<Layout title="Courses" subtitle="disc golf courses around Melbourne" cmsPath="/collections/courses">
	<Text>

		<LocationsMap locations={courseLocations} />

		<Section title="Main courses">

			<p>
				These are courses that we regularly play at, and recommend to new players.
			</p>

			<Grid>
				{featuredCourses.map((course) => (
					<CourseCard
						name={course.data.title}
						href={`/courses/${course.slug}`}
						location={course.data.suburb}
						image={course.data.thumbnail || course.data.mainImage}
					/>
				))}
			</Grid>
		</Section>

		{otherCourses.length > 0 && (
			<Section title="Other courses">
				<p>
					These courses are smaller, still in development, or further from Melbourne.
				</p>
				<Grid>
					{otherCourses.map((course) => (
						<CourseCard
							name={course.data.title}
							href={`/courses/${course.slug}`}
							location={course.data.suburb}
							image={course.data.thumbnail || course.data.mainImage}
						/>
					))}
				</Grid>
			</Section>
		)}

		<Section title="Further afield">
			<Grid>
				<LinkPanel
					href="https://flyspot.com.au"
					title="FlySpot"
					description="Disc golf courses around Australia"
					image="https://flyspot.com.au/wp-content/uploads/2016/09/FlySpot-Icon.svg"
				/>
				<LinkPanel
					href="https://udisc.com"
					title="UDisc"
					description="Disc golf courses around the world!"
					image="https://d1q6yb84lp43gi.cloudfront.net/logos2021/short/OB_U+Icon.svg"
				/>
			</Grid>
		</Section>
	</Text>
</Layout>
