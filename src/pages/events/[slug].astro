---
import { getCollection, getEntry } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import Text from '@components/Text.astro';
import Grid from '@components/Grid.astro';
import LinkPanel from '@components/LinkPanel.astro';
import LocationsMap from '@components/LocationsMap.astro';
import { formatDateRange } from '@utils/dates';

export async function getStaticPaths() {
  const events = await getCollection('events');
  return events.map((event) => ({
    params: { slug: event.slug },
    props: { event },
  }));
}

const { event } = Astro.props;
const { Content } = await event.render();

// Get course locations for the map
const courseLocations = [];
if (event.data.courses) {
  for (const courseRef of event.data.courses) {
    const course = await getEntry(courseRef);
    if (course?.data.location) {
      try {
        const parsed = JSON.parse(course.data.location);
        if (parsed.type === 'Point' && parsed.coordinates) {
          courseLocations.push({
            lat: parsed.coordinates[1],
            lng: parsed.coordinates[0],
            title: course.data.title,
            href: `/courses/${course.slug}`
          });
        }
      } catch (e) {
        // Ignore parse errors
      }
    }
  }
}
---

<Layout
  title={event.data.title}
  subtitle={formatDateRange(event.data.date, event.data.endDate)}
  cmsPath={`/collections/events/entries/${event.slug}`}
  heroImage={event.data.heroImage && {
    src: event.data.heroImage,
    alt: event.data.title,
    class: 'max-h-96 object-contain'
  }}
>
  <Text>

    <Content />

    {courseLocations.length > 0 && (
      <section>
        <h2>Location</h2>
        <LocationsMap locations={courseLocations} permanentTooltips />
      </section>
    )}

    {event.data.pdgaEventId && (
      <section>
        <h2>PDGA event info</h2>
        <Grid>
          <LinkPanel
            href={`https://www.pdga.com/tour/event/${event.data.pdgaEventId}`}
            title="Official event page"
            icon="heroicons:information-circle"
          />
          <LinkPanel
            href={`https://www.pdga.com/live/event/${event.data.pdgaEventId}/`}
            title="Live scoring"
            icon="heroicons:presentation-chart-line"
          />
        </Grid>
      </section>
    )}

    {event.data.registrationUrl && (
      <section>
        <h2>Registration</h2>
        <Grid>
          <LinkPanel
            href={event.data.registrationUrl}
            title="Register here"
            icon="mdi:calendar-check"
          />
        </Grid>
      </section>
    )}

</Text>

</Layout>
