---
import '@styles/global.css'
import logoImage from '@images/mdgc-logo.png';
import defaultOgImage from '@images/ruffey-lake-hole-1.jpg';
import { getNavItems, type NavItem } from '@data/navigation.ts';
import { Icon } from 'astro-icon/components'
import ReportIssue from '@components/ReportIssue.astro';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

export interface HeroImage {
  src: ImageMetadata;
  alt: string;
  class?: string;
  caption?: string;
}

export interface Props {
  title: string;
  subtitle?: string;
  description?: string;  // for og:description, falls back to subtitle
  heroImage?: HeroImage;
  cmsPath?: string;  // e.g., '/collections/courses/entries/bald-hill-park'
}

const { title, subtitle, description, heroImage, cmsPath } = Astro.props;

// Build page metadata
const pageTitle = `${title} | Melbourne Disc Golf Club`;
const pageDescription = description || subtitle || 'Melbourne Disc Golf Club - promoting disc golf in Melbourne since 2007';
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const ogImageUrl = heroImage
  ? new URL(heroImage.src.src, Astro.site)
  : new URL(defaultOgImage.src, Astro.site);

// Check if current page is under a nav item
function isActiveNavItem(itemHref: string): boolean {
  if (itemHref === '/' && currentPath === '/') return true;
  if (itemHref !== '/' && currentPath.startsWith(itemHref)) return true;
  return false;
}

// Get color class for nav item based on active state
function navItemColor(itemHref: string): string {
  return isActiveNavItem(itemHref) ? 'text-white' : 'text-mdgc-blue-light';
}

const currentPath = Astro.url.pathname;

// Get navigation items dynamically
const navItems: NavItem[] = await getNavItems();

// Generate footer links
const githubUrl = 'https://github.com/melbourne-disc-golf/mdgc-website';
const cmsUrl = cmsPath ? `/cms/sveltia#${cmsPath}` : null;

// Favicon sizes to generate links for
const faviconSizes = [16, 32, 48, 192];
---

<!doctype html>
<html lang="en">
	<head>
		<title>{pageTitle}</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<meta name="description" content={pageDescription} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDescription} />
		<meta property="og:image" content={ogImageUrl} />
		<meta property="og:site_name" content="Melbourne Disc Golf Club" />

		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalUrl} />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDescription} />
		<meta name="twitter:image" content={ogImageUrl} />

		<link rel="canonical" href={canonicalUrl} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet" />
		{faviconSizes.map(size => (
			<link rel="icon" type="image/png" sizes={`${size}x${size}`} href={`/images/favicon-${size}x${size}.png`} />
		))}
	</head>
	<body class="flex flex-col min-h-screen">
		<header>
			<div id="menu-strip" class="bg-linear-to-b from-mdgc-blue-dark to-slate-900 text-white shadow-lg">
				<div id="menu-content" class="content-width flex items-center h-16 space-x-8">
					<div id="menu-logo" class="flex items-center gap-3">
						<a href="/" title="Home" class="logo-link">
							<img src={logoImage.src} alt="Melbourne Disc Golf Club" class="h-12 w-auto" />
						</a>
						<span class="lg:text-lg font-display">Melbourne Disc Golf</span>
					</div>

					<div id="menu-links" class="mx-auto">
						<nav class="hidden md:flex items-center space-x-8">
							{navItems.map(item => (
								item.subPages ? (
									<div class="relative group">
										<div class="flex items-center -ml-4">
											<a href={item.href} class={`${navItemColor(item.href)} hover:text-white hover:underline transition-colors px-4 py-1 rounded-t-md group-hover:bg-slate-800 group-hover:text-mdgc-blue-light group-hover:rounded-b-none`}>{item.title}</a>
										</div>
										<div class="absolute -left-4 mt-0 pb-2 w-auto min-w-30 bg-slate-800 text-mdgc-blue-light rounded-md shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-hover:transition-all group-hover:duration-200 group-hover:delay-300 z-1000">
											{item.subPages.map(subItem => {
												const isActive = navItemColor(subItem.href) === 'text-white';
												return (
													<a href={subItem.href} class={`block px-4 py-1 hover:text-white hover:underline transition-colors whitespace-nowrap ${navItemColor(subItem.href)} ${isActive ? 'bg-mdgc-blue-dark/30' : ''}`}>{subItem.title}</a>
												);
											})}
										</div>
									</div>
								) : (
									<a href={item.href} class={`${navItemColor(item.href)} hover:text-white hover:underline transition-colors`}>{item.title}</a>
								)
							))}
						</nav>
					</div>

					<!-- Mobile menu button -->
					<div class="md:hidden ml-auto">
						<button id="mobile-menu-button" class="text-mdgc-blue-light hover:text-white" aria-label="Toggle mobile menu">
							<Icon name="heroicons:bars-3" class="h-6 w-6" />
						</button>
					</div>
				</div>

				<!-- Mobile menu -->
				<div id="mobile-menu" class="md:hidden hidden">
					<nav class="px-2 pt-2 pb-3 space-y-1">
						{navItems.map(item => (
							item.subPages ? (
								<div>
									<a href={item.href} class={`block px-3 py-2 hover:bg-mdgc-blue-dark rounded-md font-semibold ${navItemColor(item.href)} hover:text-white transition-colors`}>{item.title}</a>
									{item.subPages.map(subItem => (
										<a href={subItem.href} class={`block px-6 py-1 text-sm hover:bg-mdgc-blue-dark rounded-md ${navItemColor(subItem.href)} hover:text-white transition-colors`}>{subItem.title}</a>
									))}
								</div>
							) : (
								<a href={item.href} class={`block px-3 py-2 hover:bg-mdgc-blue-dark rounded-md ${navItemColor(item.href)} hover:text-white transition-colors`}>{item.title}</a>
							)
						))}
					</nav>
				</div>
			</div>
		</header>

		<main class="grow">
			<div class="bg-mdgc-blue-dark text-white">
				<div id="title-content" class="content-width p-8">
					<div id="title-and-subtitle">
						<h1 class="text-4xl font-bold">{title}</h1>
						{subtitle && <p class="text-xl mt-4">{subtitle}</p>}
					</div>
				</div>
			</div>
			<div class="content-width">

				{heroImage && (
					<figure class="my-8">
						<Image
							src={heroImage.src}
							alt={heroImage.alt}
							class={`w-full rounded-lg ${heroImage.class?.includes('object-') ? '' : 'object-cover'} ${heroImage.class || ''}`}
						/>
						{heroImage.caption && (
							<figcaption class="text-sm text-gray-600 mt-2 text-center italic">
								{heroImage.caption}
							</figcaption>
						)}
					</figure>
				)}

				<slot />

			</div>
		</main>

		<footer class="bg-gray-900 text-white sm:px-6 lg:px-8 py-12 mt-auto">
			<div class="no-print content-width flex flex-row gap-8">

				<!-- Logo section -->
				<div class="shrink-0">
					<a href="/" title="Home" class="logo-link">
						<img src={logoImage.src} alt="Melbourne Disc Golf Club" class="h-12 sm:h-16 w-auto" />
					</a>
				</div>

				<!-- Navigation sections grid -->
				<nav class="flex flex-wrap mx-auto gap-4 sm:gap-6 md:gap-8 lg:gap-16 items-start">
					{navItems.map((section) => (
						<div>
							<h3 class="font-semibold mb-2">
								<a href={section.href} class={`inline-flex items-center gap-1 ${navItemColor(section.href)} whitespace-nowrap`}>
									{section.icon && <Icon name={section.icon} class="w-4 h-4" />}
									{section.title}
								</a>
							</h3>
							{section.subPages && (
								<ul class="space-y-1 hidden md:block pl-2">
									{section.subPages.map(link => (
										<li>
											<a href={link.href} class={`inline-block text-sm ${navItemColor(link.href)}`}>
												{link.title}
											</a>
										</li>
									))}
								</ul>
							)}
						</div>
					))}
				</nav>

			</div>

			<!-- Bottom section -->
			<div class="border-t border-gray-700 mt-8 pt-2 flex flex-col md:flex-row justify-between items-center gap-4">
				<div class="text-gray-400 text-sm text-center md:text-left">
					<p>Â© {new Date().getFullYear()} Melbourne Disc Golf Club. All rights reserved.</p>
					<p class="text-xs text-gray-500 mt-1">last updated: {new Date().toLocaleString('en-AU', { timeZone: 'Australia/Melbourne', dateStyle: 'medium', timeStyle: 'short' })}</p>
				</div>
				<div class="no-print flex items-center gap-4">
					{cmsUrl && (
						<a href={cmsUrl} target="_blank" rel="noopener noreferrer" class="inline-block text-gray-400 hover:text-white transition-colors" aria-label="Edit page in CMS" title="Edit in CMS">
							<Icon name="mdi:pencil" class="h-5 w-5" />
						</a>
					)}
					<a href={githubUrl} target="_blank" rel="noopener noreferrer" class="inline-block text-gray-400 hover:text-white transition-colors" aria-label="View source on GitHub" title="View source on GitHub">
						<Icon name="mdi:github" class="h-5 w-5" />
					</a>
					<ReportIssue />
				</div>
			</div>

		</footer>

	</body>
</html>

<style>
	@import "tailwindcss";

	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}

	.logo-link {
		display: inline-block;
	}

	.logo-link:hover {
		transform: scale(1.15);
	}

	footer nav a {
		@apply hover:text-white hover:underline transition-colors;
	}

	@media print {
		.no-print {
			display: none;
		}
	}
</style>

<script>
	const mobileMenuButton = document.getElementById('mobile-menu-button');
	const mobileMenu = document.getElementById('mobile-menu');

	mobileMenuButton?.addEventListener('click', () => {
		mobileMenu?.classList.toggle('hidden');
	});
</script>

<script src="../scripts/heading-links.ts"></script>
